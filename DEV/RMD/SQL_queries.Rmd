---
title: "Some test SQL queries"
output: html_document
---


```{sql connection=con}
-- create source to standard concept mapping table
WITH VOCAB_MAP AS(
 SELECT C.CONCEPT_CODE    AS SOURCE_CODE, 
    C.CONCEPT_ID          AS SOURCE_CONCEPT_ID,
    C.CONCEPT_NAME        AS SOURCE_CONCEPT_NAME,
    C.VOCABULARY_ID       AS SOURCE_VOCABULARY_ID,
    C.DOMAIN_ID           AS SOURCE_DOMAIN_ID,
    C.VALID_START_DATE    AS SOURCE_VALID_START_DATE,
    C.VALID_END_DATE      AS SOURCE_VALID_END_DATE,
    C.INVALID_REASON      AS SOURCE_INVALID_REASON,
    C1.CONCEPT_ID         AS TARGET_CONCEPT_ID,
    C1.CONCEPT_NAME       AS TARGET_CONCEPT_NAME,
    C1.VOCABULARY_ID      AS TARGET_VOCABULARY_ID,
    C1.DOMAIN_ID          AS TARGET_DOMAIN_ID,
    C1.CONCEPT_CLASS_ID   AS TARGET_CONCEPT_CLASS_ID,
    C1.INVALID_REASON     AS TARGET_INVALID_REASON,
    C1.STANDARD_CONCEPT   AS TARGET_STANDARD_CONCEPT
  FROM testdb.cdm.CONCEPT C
    JOIN testdb.cdm.CONCEPT_RELATIONSHIP CR ON C.CONCEPT_ID = CR.CONCEPT_ID_1 AND CR.INVALID_REASON IS NULL AND CR.RELATIONSHIP_ID = 'Maps to'
    JOIN testdb.cdm.CONCEPT C1 ON CR.CONCEPT_ID_2 = C1.CONCEPT_ID AND C1.INVALID_REASON IS NULL
  )
  SELECT * INTO ##VOCAB_MAP 
  FROM VOCAB_MAP
  /* EXAMPLE FILTERS */
  WHERE SOURCE_VOCABULARY_ID IN('ICD9CM', 'ICD10CM') AND TARGET_STANDARD_CONCEPT IN('S')

```

